<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Field Survey Form</title>
	<!-- <link rel="stylesheet" type="text/css" href="../../scripts/assets/css/FieldSurvey.css">  -->
	<link rel="stylesheet" type="text/css" href="scripts/assets/css/FieldSurvey.css">
	<link rel="manifest" href="manifest.json">
	<script src="scripts/dexie/dexie.min.js"></script>
	<script src="scripts/dexie/dexie.js"></script>
	<script src="scripts/js/uid.js"></script>
	<script src="scripts/js/idb-init.js"></script>
	<!--Source: font awesome cdn (https://cdnjs.com/libraries/font-awesome) -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<!--Source: jquery cdn (https://bootstrapcdn-dev-pr-1284.herokuapp.com/fontawesome/)-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="./tableManager.js"></script>
	<!-- RESPOND TO CHANGE IN ONLINE OR OFFLINE -->
    <script src="scripts/js/gone-offline.js"></script>
    
	<!--iOS support-->
	<link rel="apple-touch-icon" href="icons/icon-96.png">
	<meta name="apple-mobile-web-app-status-bar" content="#00695c">
	<meta name="theme-color" content="#00695c">
	<!--iOS support-->	
</head>




<body>
	<div class="container">

		<div class="title">
			FIELD SURVEY FORM
		</div>
		<!-- For offline/online status -->
		<div id="status"></div>
		
		<!-- <p style="float: right;"><a href="/DigiPathoFS/views/digipathofs/MainPage.html">Back</a></p>  --> 
		<p style="float: right;"><a href="MainPage.html">Home</a></p> 
		<h5> Person Details </h5>
		<div class="form">
			<form name="personForm">
				<div class="input-field">
					<label>NAME</label>
					<input type="text" id="name" class="input">
				</div>

				<div class="input-field">
					<label>DATE OF BIRTH</label>
					<input type="date" id="dob" class="input">
				</div>
				
				<div class="input-field">
					<label>AGE</label>
					<input type="text" class="input inp" id="yearinput" placeholder="Year">
					<input type="text" class="input inp" id="monthinput" placeholder="Month">
				</div>
				
				<div class="input-field">
					<label>SEX</label>
					<div class="custom_select">
					<select id="sex">
						<option>Select</option>
						<option>Male</option>
						<option>Female</option>
						<option>Other</option>
					</select>
					</div>
				</div>

				<div class="input-field">
					<label>MARITAL STATUS</label>
					<div class="custom_select">
					<select id="mstatus">
						<option>Select</option>
						<option>Married</option>
						<option>Unmarried</option>
					</select>
					</div>
				</div>				

				<div class="input-field">
					<label>MOBILE NO</label>
					<input type="phone" id="mobile" class="input">
				</div>						

				<div class="input-field">
					<label>HOUSE NAME</label>
					<input type="text" id="house" class="input">
				</div>

				<div class="input-field">
					<label>AADHAAR NO</label>
					<input type="text" id="aadhaar" class="input">
				</div>			

				<div class="input-field">
					<label>WARD</label>
					<input type="number" id="ward" class="input">
				</div>

				<div class="input-field">
					<label>PANCHAYATH</label>
					<input type="text" id="panchayath" class="input">
				</div>
				
				<div class="input-field">
					<label>DISTRICT</label>
					<div class="custom_select">
					<select name="district" id="district" class="form-control">
					<option value="Alappuzha">Alappuzha</option>
					<option value="Ernakulam">Ernakulam</option>
					<option value="Idukki">Idukki</option>
					<option value="Kannur">Kannur</option>
					<option value="Kasaragod">Kasaragod</option>
					<option value="Kollam">Kollam</option>
					<option value="Kottayam">Kottayam</option>
					<option value="Kozhikode">Kozhikode</option>
					<option value="Malappuram">Malappuram</option>
					<option value="Palakkad">Palakkad</option>
					<option value="Pathanamthitta">Pathanamthitta</option>
					<option value="Thiruvananthapuram">Thiruvananthapuram</option>
					<option value="Thrissur">Thrissur</option>
					<option value="Wayanad" selected>Wayanad</option>
					</select>
					</div>
				</div>	

				<div class="input-field">
					<label>STATE</label>
					<div class="custom_select">
					<select name="state" id="state" class="form-control">
					<option value="Andhra Pradesh">Andhra Pradesh</option>
					<option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
					<option value="Arunachal Pradesh">Arunachal Pradesh</option>
					<option value="Assam">Assam</option>
					<option value="Bihar">Bihar</option>
					<option value="Chandigarh">Chandigarh</option>
					<option value="Chhattisgarh">Chhattisgarh</option>
					<option value="Dadar and Nagar Haveli">Dadar and Nagar Haveli</option>
					<option value="Daman and Diu">Daman and Diu</option>
					<option value="Delhi">Delhi</option>
					<option value="Lakshadweep">Lakshadweep</option>
					<option value="Puducherry">Puducherry</option>
					<option value="Goa">Goa</option>
					<option value="Gujarat">Gujarat</option>
					<option value="Haryana">Haryana</option>
					<option value="Himachal Pradesh">Himachal Pradesh</option>
					<option value="Jammu and Kashmir">Jammu and Kashmir</option>
					<option value="Jharkhand">Jharkhand</option>
					<option value="Karnataka">Karnataka</option>
					<option value="Kerala" selected>Kerala</option>
					<option value="Madhya Pradesh">Madhya Pradesh</option>
					<option value="Maharashtra">Maharashtra</option>
					<option value="Manipur">Manipur</option>
					<option value="Meghalaya">Meghalaya</option>
					<option value="Mizoram">Mizoram</option>
					<option value="Nagaland">Nagaland</option>
					<option value="Odisha">Odisha</option>
					<option value="Punjab">Punjab</option>
					<option value="Rajasthan">Rajasthan</option>
					<option value="Sikkim">Sikkim</option>
					<option value="Tamil Nadu">Tamil Nadu</option>
					<option value="Telangana">Telangana</option>
					<option value="Tripura">Tripura</option>
					<option value="Uttar Pradesh">Uttar Pradesh</option>
					<option value="Uttarakhand">Uttarakhand</option>
					<option value="West Bengal">West Bengal</option>
					</select>
					</div>
				</div>	
			
				<div class="input-field">
					<label>COUNTRY</label>
					<input type="text" id="country" class="input" placeholder="India">
				</div>	

				<div class="input-field">
					<label>PINCODE</label>
					<input type="number" id="pin" class="input">
				</div>	

				<div class="btn-field">
					<!-- <input type="submit" style='margin-right:16px' class="btn" id ="submit" value="SAVE"> -->
					<button id="submit" class="btn">SAVE</button>
					<!-- <button class="btn" value="CLEAR" id ="clearBtnID">CLEAR</button> -->
					<!-- <input type="button" class="btn" value="CLEAR" id ="clearBtnID"> -->
				</div>		
			</form>	
			      <section>
        <h3>List</h3>
        <ul class="wList">
          <!-- build list here -->
        </ul>
      </section>
			<div id="output" style="margin-top:20px;"></div>											
		</div>
	</div>

   
	<script>
	
	console.log("inside field survey html script tag, for idb working");
	//import { uid } from 'scripts/js/uid.js';
	//console.log(uid());
	var uniq = 'id' + (new Date()).getTime();            //creating unique id
	console.log(uniq);
	  
	//var db = new Dexie("DigiPathoFSDB");
	
	/*db.version(1).stores({
		fs_person_registration: "++fs_person_id, global_fs_person_id, fs_inst_id, person_name, dob, age, gender, marital_status, mobile_no, house_name, aadhaar_no, ward_id, panchayath_id, district_id, state_id, country_id, pincode, user_id, created_date, is_valid"
	});*/
	
	//Log DB details -- opens an existing database as is
	//db.open();
	/*db.open().catch (function (err) {
		console.error('Failed to open db: ' + (err.stack || err));
	});*/
	
	//opening already created IDB
	var db = new Dexie("DigiPathoFSDB")
	  .open()
	  .then(function (db) {
	    console.log("Found database: " + db.name);
	    console.log("Database version: " + db.verno);
	    db.tables.forEach(function (table) {
	      console.log("Found table: " + table.name);
	      console.log("Table Schema: " + JSON.stringify(table.schema, null, 4));
	    });
	  })
	  .catch("NoSuchDatabaseError", function (e) {
	    // Database with that name did not exist
	    console.error("Database not found");
	  })
	  .catch(function (e) {
	    console.error("Oh uh: " + e);
	  });
	
	
	/*function add_new(name, dob, yearinput, sex, mstatus, mobile, house, aadhaar, ward, panchayath, district, state, country, pin){
	    // Interact With Database
	    db.transaction('rw', db.fs_person_registration, function () {
	        // Let's add some data to db:
	        insert_object = {
								person_name:name, dob:dob, age:yearinput, gender:sex, marital_status:mstatus, mobile_no:mobile, house_name:house,
								aadhaar_no:aadhaar, ward_id:ward, panchayath_id:panchayath, district_id:district, state_id:state, country_id:country,
								pincode:pin
							};
	        db.fs_person_registration.add(insert_object);
	    }).catch(function(err) {
	        console.error(err.stack || err);
	        console.log("ERROR");
	    });    
	}*/



	//add_new("susheel singh","susheel61@gmail.com");//default content
	//add_new("susheel singh","1987-09-28","35","Female","Married","944778932","SH2, Sulthan Bathery","4565545654","WARD2","PANCH5","DIST14","STA28","IND","689542","Doctor1","2022-09-27",true);//default content
	/*document.querySelector("button").addEventListener("click",function(e){
		//document.getElementById('submit').addEventListener('click', function (event) {
			//preventing default submission of the form
			//event.preventDefault();
			//console.log("Default event prevented!!!!");
			//console.log("button clicked");
	    add_new(
			document.getElementById('name').value.trim(),
			document.getElementById('dob').value.trim(),
			parseInt(document.getElementById('yearinput').value),
			//parseInt(document.getElementById('monthinput').value),
			document.getElementById('sex').value,
			document.getElementById('mstatus').value,
			document.getElementById('mobile').value.trim(),
			document.getElementById('house').value.trim(),
			document.getElementById('aadhaar').value.trim(),
			document.getElementById('ward').value.trim(),
			document.getElementById('panchayath').value.trim(),
			document.getElementById('district').value,
			document.getElementById('state').value,
			document.getElementById('country').value.trim(),
			document.getElementById('pin').value.trim()
			);
	});*/
	
		// 
		// 40 form send event listener
		document.getElementById('submit').addEventListener('click', function (event) {
			//preventing default submission of the form
			event.preventDefault();
			console.log("Default event prevented!!!!");
			
		    /*add_new(
					document.getElementById('name').value.trim(),
					document.getElementById('dob').value.trim(),
					parseInt(document.getElementById('yearinput').value),
					//parseInt(document.getElementById('monthinput').value),
					document.getElementById('sex').value,
					document.getElementById('mstatus').value,
					document.getElementById('mobile').value.trim(),
					document.getElementById('house').value.trim(),
					document.getElementById('aadhaar').value.trim(),
					document.getElementById('ward').value.trim(),
					document.getElementById('panchayath').value.trim(),
					document.getElementById('district').value,
					document.getElementById('state').value,
					document.getElementById('country').value.trim(),
					document.getElementById('pin').value.trim()
					);*/
		
			function add_new(name, dob, yearinput, sex, mstatus, mobile, house, aadhaar, ward, panchayath, district, state, country, pin){
			    // Interact With Database, fs_person_registration is one of the field names of IDB
			    db.transaction('rw', db.fs_person_registration_sync, function () {
			        // Let's add some data to db:
			        insert_object = {
			        					fs_person_id:uniq, person_name:name, dob:dob, age:yearinput, gender:sex, marital_status:mstatus, mobile_no:mobile, house_name:house,
										aadhaar_no:aadhaar, ward_id:ward, panchayath_id:panchayath, district_id:district, state_id:state, country_id:country,
										pincode:pin
									};
			        db.fs_person_registration_sync.add(insert_object);
					
			        //Obtaining all records from a table using dexie.js 
			        const all = db.table("fs_person_registration_sync").toArray();
			        console.log("Data stored in idb...");
					
					//saving only the information into an array
					var list = [];
					db.fs_person_registration_sync.orderBy("fs_person_id").toArray()
					.then(list => {
						/*list.forEach(item => {
						//something
						console.log(" LIST ", list);
						});*/
						console.log(" LIST ", list);
						
						//converting to a JSON array for using in web-service call
						var myJsonString = JSON.stringify(list);
						console.log("JSON LIST ", myJsonString);
					})
					.catch(error => {
						// handle error
						console.log(error);
					});
					
			    }).catch(function(err) {
			        console.error(err.stack || err);
			        console.log("ERROR OCCURRED when calling the form values and mappping with IDB fields");
			    });    
			}
		    
			//getting all the fields
		/*var person_name = document.getElementById('name').value.trim();
		var dob = document.getElementById('dob').value.trim();
		var yearinput = parseInt(document.getElementById('yearinput').value);
		var monthinput = parseInt(document.getElementById('monthinput').value);
		var gender = document.getElementById('sex').value;
		var marital_status = document.getElementById('mstatus').value;
		var mobile_no = document.getElementById('mobile').value.trim();
		var house_name = document.getElementById('house').value.trim();
		var aadhaar_no = document.getElementById('aadhaar').value.trim();
		var ward_id = document.getElementById('ward').value.trim();
		var panchayath_id = document.getElementById('panchayath').value.trim();
		var district_id = document.getElementById('district').value;
		var state_id = document.getElementById('state').value;
		var country_id = document.getElementById('country').value.trim();
		var pincode = document.getElementById('pin').value.trim();
		*/
		/*console.log("name", person_name);
		console.log(typeof (person_name));
		console.log(typeof (dob));
		console.log(typeof (gender));
		console.log(typeof (marital_status));*/
		
		/*var personData = {
				syncID: uid(),
				person_name: person_name,
				dob: dob,
				yearinput: yearinput,
				monthinput: monthinput,
				gender: gender,
				marital_status: marital_status,
				mobile_no: mobile_no,
				house_name: house_name,
				aadhaar_no: aadhaar_no,
				ward_id: ward_id,
				panchayath_id: panchayath_id,
				district_id: district_id,
				state_id: state_id,
				country_id: country_id,
				pincode: pincode
			  };*/
			  
			  /*var personData = {
				syncID: uid(),
				person_name,
				dob,
				yearinput,
				monthinput,
				gender,
				marital_status,
				mobile_no,
				house_name,
				aadhaar_no,
				ward_id,
				panchayath_id,
				district_id,
				state_id,
				country_id,
				pincode
			  };
		console.log("personData: ", personData)*/

		//Background Sync code 
		
		//if the browser supports both serviceWorker and SyncManager, then carry on the further steps
		/*if ('serviceWorker' in navigator && 'SyncManager' in window) {
                                    console.log("SYNC MANAGER AVAILABLE");
                                  
                                    // serviceWorker registered at top of page       
                                    navigator.serviceWorker.ready.then(function (swRegistration) {
                                        console.log("register sync SEND");
                                        // REGISTER SYNC EVENT called fs_person_registration_sync_tag(our own custom name which should be unique to this particular background sync)
                                        swRegistration.sync.register('fs_person_registration_sync_tag');*/

                                        console.log("Saving to idb")
                                         //writing data into IDB, function of idb-fn.js
                                        //writeData("fs_person_reg", personData);	//fs_person_reg is table i.e store name
                                        
                                        //getting all the fields
									    add_new(
												document.getElementById('name').value.trim(),
												document.getElementById('dob').value.trim(),
												parseInt(document.getElementById('yearinput').value),
												//parseInt(document.getElementById('monthinput').value),
												document.getElementById('sex').value,
												document.getElementById('mstatus').value,
												document.getElementById('mobile').value.trim(),
												document.getElementById('house').value.trim(),
												document.getElementById('aadhaar').value.trim(),
												document.getElementById('ward').value.trim(),
												document.getElementById('panchayath').value.trim(),
												document.getElementById('district').value,
												document.getElementById('state').value,
												document.getElementById('country').value.trim(),
												document.getElementById('pin').value.trim()
												);
									
                                        
                                        // if online it will be sent immediately by sync event and    
                                        //if not online, display some proper message in the div id named 'output' 
                                       /* if (!navigator.onLine) {
                                            const output = document.getElementById('output');
                                            output.innerHTML =
                                                "FORM DATA SAVED AND WILL BE SENT LATER WHEN BACK ONLINE";
                                            output.style.border = '2px solid red';
                                            output.style.color = 'blue';
                                            console.log("OFFLINE - so, if block worked");
                                        } else {		//otherwise, if online, automatically synced 
                                            // TO DO
                                            // post form as we are online
                                            const output = document.getElementById('output');
                                            output.innerHTML =
                                                "FORM DATA SENT";
                                           output.style.border = '2px solid avocado';
                                           output.style.color = 'green';
                                           console.log("ONLINE - So, else block worked, data directly sent.");
                                        }
                                    });
                                } else {
                                	//if the browser does not support both serviceWorker and SyncManager, then post the form in a regular way
                                    console.log("Browser does not support serviceWorker and SyncManager");
                                	alert("does not support offline capability!!!!");
                                }	*/



		/*db.transaction("rw", db.fs_person_registration,  function* () {
			  // Let's add some data to db:
			  var userdata = yield db.fs_person_registration.add({
			    global_user_id: "GUSR222",
			    user_id: "UU1",
			    person_name: person_name,
			    dob: dob,
			    gender: gender,
			    marital_status: marital_status
			    ///
			  });
			 }).catch(function (err) {
			  // Catch any error event or exception and log it:
			 console.error(err.stack || err);
			 console.log("ERRPR")
			});*/
			
	    /*let tx = makeTX('fs_person_registration_sync', 'readwrite');
	    tx.oncomplete = (ev) => {
	      console.log("calling bldlsttttttt", ev);
	      buildList();
	      //clearForm(); 
	    };
	    */

	    

		});
	
	  /*function buildList() {
		    //use getAll to get an array of objects from our store
		    let list = document.querySelector('.wList');
		    list.innerHTML = `<li>Loading...</li>`;
		    let tx = makeTX('fs_person_registration_sync', 'readonly');
		    tx.oncomplete = (ev) => {
		      //transaction for reading all objects is complete
		    };
		    let store = tx.objectStore('fs_person_registration_sync');
		    let getReq = store.getAll();
		    //returns an array
		    //option can pass in a key or a keyRange
		    getReq.onsuccess = (ev) => {
		      //getAll was successful
		      let request = ev.target; //request === getReq === ev.target
		      console.log({ request });
		      list.innerHTML = request.result
		        .map((insert_object) => {
		          return `<li data-key="${insert_object.fs_person_id}"><span>${insert_object.name}</span> ${insert_object.gender}</li>`;
		        })
		        .join('\n');
		    };
		    getReq.onerror = (err) => {
		      console.warn(err);
		    };
		  }	*/	
	  
	  /*function makeTX(storeName, mode) {
		    let tx = db.transaction(storeName, mode);
		    tx.onerror = (err) => {
		      console.warn(err);
		    };
		    return tx; 
		  }*/
	  
	  
		</script>	  
			<!-- <script src="scripts/js/app.js"></script>  -->
 	<script type="text/javascript" src="scripts/js/promise.js"></script>
	<script type="text/javascript" src="scripts/js/fetch.js"></script>
	<script type="text/javascript" src="scripts/js/app.js"></script>	
	<script type="module" src="scripts/js/fsapp.js"></script>
	<script src="scripts/js/idb-init.js"></script>
	<!-- <script src="scripts/js/idb.js"></script>  -->
	<!-- <script src="scripts/js/idb-fn.js"></script>  -->                     

</body>
</html>